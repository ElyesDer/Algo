//
//  main.swift
//  algo
//
//  Created by 360medlink Tunisia on 5/28/20.
//  Copyright © 2020 360medlink Tunisia. All rights reserved.
//

import Foundation


print("Hello, Algorithm")

var raw = "ASSOCIAT\nBIZERTE\n2050\nBorhéne DHAOUADI\nPrésident\nFondateur\nCoworking Business Center - CBC\nAvenue de I'Environnement Zarzouna\n(+216) 23 40 41 79\n7021 - Bizerte - Tunisie\n2\nborhene@bizertesmartcity.com\ncontact@bizerte2050.com\n------------------------ detectFields - Raw data ---------------------------\nlevio\nAFFAIRES ET TECHNOLOGIES\nJonathan Chouinard\nConseiller stratégique\n1015, Av Wilfrid-Pelletier, local 530\nChargé de projet\nQuébec (Québec) G1W 0C4\njonathan.chouinard@levio.ca\nT 418 914-3623\nwww.levio.ca\nC 418 931-8789\n------------------------ detectFields - Raw data ---------------------------\nMed Cheker Amdouni\nGraphic Designer\nPixartprinting SpA\nImmeuble Les 2 Lacs, Bloc 9,\nRue du Lac de Constance,\norinting\nLes Berges du Lac 1053,\nTunis\nmedcheker.amdouni@pixartprinting.com\n8\n------------------------ detectFields - Raw data ---------------------------\nCrea\nCUISINE\n...et vos envies prennent vie\nHichem HARBAOUI\nGérant\nN'1 Rue Bechir Bachrouch, Khaznadar 2017\n-\n(+2161 71 515 470\n(+216) 23 559 990\nhichem.harbaoui@live.fr fl Créa Cuisine\n11216 52 490 435\n------------------------ detectFields - Raw data ---------------------------\nAhmed Ayed\nConsultant\nProfessional Services\naxefinance\n+216 71 963 229\nFocus • Expertise • Value\nE ahmed.ayed@axefinance.com\n------------------------ detectFields - Raw data ---------------------------\nRyosuke Nagao\nCEO\nnagao@impetus.jp\nLead Translator\nIMPETUS\nLinguistic Consultation\nImpetus Co.\n5-31-5-1004 Honkomagome,\nBunkyo-ku, Tokyo, JAPAN\n------------------------ detectFields - Raw data ---------------------------\nSeifeddine Khelifi\nExpert Senior\nDéveloppement des Ventes\nboredoo\nImmeuble Zenith, Les Jardins du Lac\n1053, Les Berges du Lac, Tunis, Tunisie\nM : +216 22 126 4661T : +216 36 126 466\nseifeddine.khelifi@ooredoo.tn\n------------------------ detectFields - Raw data ---------------------------\n6 Leb:\n961 9 213 414\nLeb:\n961 3 075791\nKSA: + 966556450046\nD Beirut - Lebanon & Riyadh - KSA\nS dkiame\nwww.intech-mena.com\ndkiame@intech-mena.com\n------------------------ detectFields - Raw data ---------------------------\nLAZHAR NSIRI\nSUBSIDIARY DIRECTOR\nWYPLAY TUNISIA\nInsiri@wyplay.com\nFrench Mobile +33 6 19 43 30 48\nTunisia +216 97 07 06 42\nwwpoy\n------------------------ detectFields - Raw data ---------------------------\n360\\nWael Mallek\nMEDLINK\nGeneral Manager of\nTunisian operations\nHealthcare\nMobile Applications\nwaelm@360medlink.com\nmobile. +216 98 70 92 14\noffice. +1 514 448 2175\nwww.360medlink.com\nMontreal - New York I Paris I Barcelona\nTunis\n------------------------ detectFields - Raw data ---------------------------\nAnis ADDALA\n00\nDirecteur Commercial Afrique\nHead Of Sales and Business Dev. Africa\nva\nTel Fax : +216 71 267 090/ +216 71 267 091\nMobile : +216 22 111 000 /+213 56 167 27 31\n~\nanis.addala@novatel-it.com\nwww.novatel-it.com\nNOVATEL\nIn\nFarah Lake building, Rue de la Feuille d'Erable,\nBureau B2.2, 1053 les Berges du Lac2, Tunis, Tunisie\n------------------------ detectFields - Raw data ---------------------------\nJOE CHAHOUD\nGENERAL MANAGER/CTO\nmobile:\n+961 70 294 835\nSkype ID: joechahoud\nemail:\njchahoud@intech-mena.com\nTel/Fax:\n+961 213 414\nWebiste:\nwww.intech-mena.com\n------------------------ detectFields - Raw data ---------------------------\nBéchir BOUFADEN\nDirecteur Commercial\n(+216) 98 358 956\n(+216) 28 546 460\nctfec@ctfexpo.com\nbechir.boufaden@ctfexpo.com\nwww.ctfexpo.com\nLes Jardins d'El Menzah\n2094 El Mnihla Ariana\n(+216) 70 734 290\n(+216) 70 734 291\n------------------------ detectFields - Raw data ---------------------------\n62A\nAdel Ghouma\nMENA Manager\n+48 791 046 584\nG2A.com\naghouma@g2a.com\nG2A.co\n------------------------ detectFields - Raw data ---------------------------\nréinventez votre vie\nIlyes KHEMIRI\nDirecteur Commercial\nDéco-pierre\n23 Rue Feyrouz Cite El Fawz\nEnnasr 3 - Tunis\nFb: Déco-pierre\nTel.: 29 403 488\nE-mail:decopierre2013@gmail.com\n21 031 700\n------------------------ detectFields - Raw data ---------------------------\nN\nSage\nIntégrateur\nNOVASOFT\nde Solutions\nElyes TALMOUDI\nGérant\nPortable: 20 279 500\nTél.: +(216) 71 860 636\nFax: +(216) 71 862 627\nAdresse: Bur B1,\nRésidence El Mouna\nRue du lac Malaren, les berges du lac, Tunis\nE-mail: elytal.bmda@topnet.tn\n------------------------ END Raw data ---------------------------\n------------------------ detectFields - Raw data ---------------------------\nMaiborn\nWolff\nMenrl\"t PROF. Sadok Chekir\nDiplom Ingenieur\nIT Architect\nsadok.chekir@maibornwolff.de\nMobil +49 151 544 22 153\nMaibornWolff GmbH\nTheresienhohe 13 - 80339 Munchen\nmaibornwolff.de\n------------------------ detectFields - Raw data ---------------------------\nTechlimed\nINFORMATION LINGUISTICS TECHNOLOGY\nDr. Ramzi ABBES\nPresident & C.E.O.\n42, rue de 1'Université - 69007 Lyon France\nPhone : +33 (0)4 78 58 32 35\nMobile : +33 (0)6 22 47 28 74\nSkype : ramziabbes\nEmail: ramzi.abbes@techlimed.com\ntechlimed.com"

//raw = "prof. Habib Zaghal\nINFORMATION LINGUISTICS TECHNOLOGY"
//******************************        PRE PROCESS         ******************************//

raw = "Tel : 24608993 / 24 655 509"

var raws = [
  /*
    
    "ASSOCIAT\nBIZERTE\n2050\nBorhéne DHAOUADI\nPrésident\nFondateur\nCoworking Business Center - CBC\nAvenue de I'Environnement Zarzouna\n(+216) 23 40 41 79\n7021 - Bizerte - Tunisie\n2\nborhene@bizertesmartcity.com\ncontact@bizerte2050.com\nBizerte\nSmart City\nWe realize it\nwww.bizertesmartcity.com\n",

         
         
         
         


     "Med Cheker Amdouni\nGraphic Designer\nPixartprinting SpA\nImmeuble Les 2 Lacs, Bloc 9,\nRue du Lac de Constance,\norinting\nLes Berges du Lac 1053,\nTunis\nmedcheker.amdouni@pixartprinting.com\n8\n",

     "Crea\nCUISINE\n...et vos envies prennent vie\nHichem HARBAOUI\nGérant\nN'1 Rue Bechir Bachrouch, Khaznadar 2017\n-\n(+2161 71 515 470\n(+216) 23 559 990\nhichem.harbaoui@live.fr fl Créa Cuisine\n11216 52 490 435\n",

     

     "Ryosuke Nagao\nCEO\nnagao@impetus.jp\nLead Translator\nIMPETUS\nLinguistic Consultation\nImpetus Co.\n5-31-5-1004 Honkomagome,\nBunkyo-ku, Tokyo, JAPAN\n",

     

"6 Leb:\n961 9 213 414\nLeb:\n961 3 075791\nKSA: + 966556450046\nD Beirut - Lebanon & Riyadh - KSA\nS dkiame\nwww.intech-mena.com\ndkiame@intech-mena.com\n",

"LAZHAR NSIRI\nSUBSIDIARY DIRECTOR\nWYPLAY TUNISIA\nInsiri@wyplay.com\nFrench Mobile +33 6 19 43 30 48\nTunisia +216 97 07 06 42\nwwpoy\n",

"nWael Mallek\nMEDLINK\nGeneral Manager of\nTunisian operations\nHealthcare\nMobile Applications\nwaelm@360medlink.com\nmobile. +216 98 70 92 14\noffice. +1 514 448 2175\nwww.360medlink.com\nMontreal - New York I Paris I Barcelona\nTunis\n",


 
 
   
    
    
    
    "Béchir BOUFADEN\nDirecteur Commercial\n(+216) 98 358 956\n(+216) 28 546 460\nctfec@ctfexpo.com\nbechir.boufaden@ctfexpo.com\nwww.ctfexpo.com\nLes Jardins d'El Menzah\n2094 El Mnihla Ariana\n(+216) 70 734 290\n(+216) 70 734 291\n",
    
    
    
    
    
    
    
    "Maiborn\nWolff\nMenrl\"t\nSadok Chekir\nDiplom Ingenieur\nIT Architect\nsadok.chekir@maibornwolff.de\nMobil +49 151 544 22 153\nMaibornWolff GmbH\nTheresienhohe 13 - 80339 Munchen\nmaibornwolff.de\n",
 
 
 
 
 "Techlimed\nINFORMATION LINGUISTICS TECHNOLOGY\nRamzi ABBES\nPresident & C.E.O.\n42, rue de 1'Université - 69007 Lyon France\nPhone : +33 (0)4 78 58 32 35\nMobile : +33 (0)6 22 47 28 74\nSkype : ramziabbes\nEmail: ramzi.abbes@techlimed.com\ntechlimed.com\n",
 
 

 "N\nSage\nIntégrateur\nNOVASOFT\nde Solutions\nElyes TALMOUDI\nGérant\nPortable: 20 279 500\nTél.: +(216) 71 860 636\nFax: +(216) 71 862 627\nAdresse: Bur B1,\nRésidence El Mouna\nRue du lac Malaren, les berges du lac, Tunis\nE-mail: elytal.bmda@topnet.tn\n",
 
 */
 
 "Seifeddine Khelifi\nExpert Senior\nDéveloppement des Ventes\nboredoo\nImmeuble Zenith, Les Jardins du Lac\n1053, Les Berges du Lac, Tunis, Tunisie\nM : +216 22 126 4661T : +216 36 126 466\nseifeddine.khelifi@ooredoo.tn\n",

 
 
 
 "réinventez votre vie\nIlyes KHEMIRI\nDirecteur Commercial\nDéco-pierre\n23 Rue Feyrouz Cite El Fawz\nEnnasr 3 - Tunis\nFb: Déco-pierre\nTel.: 29 403 488\nE-mail:decopierre2013@gmail.com\n21 031 700\n",

 
 "62A\nAdel Ghouma\nMENA Manager\n+48 791 046 584\nG2A.com\naghouma@g2a.com\nG2A.co\n",
 
 
 "Anis ADDALA\n00\nDirecteur Commercial Afrique\nHead Of Sales and Business Dev. Africa\nva\nTel Fax : +216 71 267 090/ +216 71 267 091\nMobile : +216 22 111 000 /+213 56 167 27 31\n~\nanis.addala@novatel-it.com\nwww.novatel-it.com\nNOVATEL\nIn\nFarah Lake building, Rue de la Feuille d'Erable,\nBureau B2.2, 1053 les Berges du Lac2, Tunis, Tunisie\n",
 
 
 
  "JOE CHAHOUD\nGENERAL MANAGER/CTO\nmobile:\n+961 70 294 835\nSkype ID: joechahoud\nemail:\njchahoud@intech-mena.com\nTel/Fax:\n+961 213 414\nWebiste:\nwww.intech-mena.com\n",

  
  
 "Ahmed Ayed\nConsultant\nProfessional Services\naxefinance\n+216 71 963 229\nFocus • Expertise • Value\nE ahmed.ayed@axefinance.com\n",
 
 
 
 "levio\nAFFAIRES ET TECHNOLOGIES\nJonathan Chouinard\nConseiller stratégique\n1015, Av Wilfrid-Pelletier, local 530\nChargé de projet\nQuébec (Québec) G1W 0C4\njonathan.chouinard@levio.ca\nT 418 914-3623\nwww.levio.ca\nC 418 931-8789\n",
 
]


//raws = [
//
//    "Edouard ALCAY\nAOCPATRIMOINE\n3, reu aubourg (faint Whore\no14‡43017\nz5008 ..\n#7. 133 trepho-tons\n.Mas.\n88\ne-mail: ealray2aocpatrimoine.com\n","Alexanommo.png\nFRANKLIN\nLAW FIRM\nStéphanie Alexandrino\nMember of the Bars of Paris\nand Luxembourg\n26, avenue Kléber 75116 Paris\nTel.: +33 (0]1 45 02 79 09\nFax: +33 (0]1 45 02 79 01\nwww.franklin-paris.com-salexandrino@n-pr.\n",
//
//    
//    "WE\nCAPTURE\nWHAT\nMOVES\nDr Eric Angelini\nVP Global Regulatory Affairs\n& Products Safety\nMANE\nTel. direct line + 33 4 92 42 49 01\nFax + 33 4 93 42 54 25\nMobile + 33 6 82 93 81 75\n620, route de Grasse\nF-06620 Le Bar-sur-Loup\neric.angelini@mane.com\nwww.mane.com\n","ILY\ne\nA\nSearch\nBRYAN, GARNIER & Co\nFrancois Arpels\nManaging Director\nBryan, Garnier & Co\nCorporate Finance\n26, avenue des Champs-Elysees\n75008 Paris\nTel\n+33 (0)1 70 36 57 43\nFax\n+33 (011 56 66 75 21\nMobile: +33 (0)6 73 12 98 64\ne-mail - farpels@bryangarnier.com\n","DeM\nAsad Zahur\nChairman\naz@hnmglobal.co\n1603 Jumeirah Business Centre 4 ILT N cluster, PO BOX 454381 DUBAI, UAE\nTel: +9714-4304314, Fax: +9714-4304574\n","Michel Auclair\nAssocie\nco\nauclair dupont\nCONSEIL EN ENTREPRISES\nTel: (687) 24 10 30\nGrand Theatre\nFax: (687) 24 10 45\n0 u0 SIEN attes\nmail michelaudair@auclairdupont.nc\nanATo2 ess4s Noume Cece\nwww.aucairdupont.nc\n",
//    
//    
//    "Ecole d e\nManagement\nStrasbourg\nUNIVERSITE DE STRASBOURG\nWilfrid AZAN\nMattre de conferences\nen Sciences de gestion\n61 avenue de la Foret-Noire\n67085 Strasbourg Cedex\nTel. -33 (013 68 85 89 25\nazancunistra.i\nwww.em-strasbourg.eu\n","WILL\nr. Droit Creatif - Azan & Associes\nWilliam Azan\nAvocat Associé\n92, Avenue de Saint-Mandé - 75012 PARIS\nTel.: 33(0)1 42 56 08 20 - Port. : 06 86 86 32 50 william.azan@uwill.fr\n","A\nCREDIT AGRICOLE\nNORD DE FRANCE\nBALLE-DERLY Carine\nResponsable dunite Contentleux entreprises, professionnels et agriculteurs\nDGA/CTX - CONTENTIEUX\n62000 ARRAS\nTel\n03 21 07 59 38-Fax 03 21 07.76.84\ncarna balie dedyfca nordoofrance.f\n","B Atelier Beaumarchals\nMailre Arlison Bollier 9\nCordonnier . Bottier . Maroquinier\nRéparation en Maroquinerie\n30 rue de Turbigo\nOuvert du lundi au samedi\n75003 Paris\nde 10:00 a 19:30\nTel: 01 44 93 51 15\n","will be group\nBernard Attali\nPrésident/Conseil en investissement financier\nMembre de la CNCIF D012068\nExpert financier membre de la CNCEF\nGOUVEINANCL & VALEUES\nbernard.attali@willbegroup.com\n+33(0)7 86 76 69 74\n+33(0)1 42 33 13 33\nChargé d'enseignement\nEDHEC (Lille)\nESSEC\nPARIS 22 RUE DE LARCADE\nIAE (Aix-en-Provence)\n75008 - T. 33(0)1 42 33 13 33\nParis 2 Panthéon ASSAS\nGENEVA RUE DE LATHENEE 40\n1206 - T 41(0) 22 588 65 30\nBRUSSELS 209A, AVENUE LOUISE\n1050 - T. • 32 (0) 2 627 55 70\ngouval.com\n","Pries\nGrégory Antoine\nConsultants Network\n+33 6 07 39 37 12 - contact@1001pommes.com\n","CAYMAN ISLANDS HELICOPTERS\nPL GENOT\nHELICOPTERE\nJerome Begot\nP.O. Box 738, Grand Cayman, KYI-1103,\nCayman Islands\nPhone: 345 943-4354\nCell: (345) 926-6967\nE-mail jbhelicopters@candw.ky OR\ncihelicopters@yahoo.com\nwww.caymanislandshelicopters.com\n",
//"alister\nAVOCATS\nProf. Dr. Jochen BAUERREIS\nAvocat & Rechtsanwalt\nAvocat spécialise en droit des relations internationales\nDirecteur du Magistere Juristes d'Affaires Franco-Allemands\n11, rue du Parc\n67205 Strasbourg. Oberhausbergen\nTel. : +33 (0)3 68 00 14 10\nFax : +33 (0)3 68 00 14 11\njochen.bauerreis@alister-avocats.com\n","IF\nTRADE\nENGINEERING\nMassimiliano Avogadri\nBusiness development bureau\nwww.ffengineerltd.com\nm.avogadri@ffengineerItd.com\nSkype: Massimiliano.avogadri\nF&F Engineering Ltd\n7th Floor 52-54 Gracechurch Street EC3V.OEH London (UK)\n","start inoost\nKevin Aserraf\nAnalyste\nkevin@startinpost.com\nTél. : +33 1011 70 60 90 36\nMob. +33 (0]6 66 85 89 26\nwww.startinpost.com\nTOUR CRISTAL\n11 QUAI ANDRE CITROEN- 75015 PARIS\n","TEAMLOG\nDEPARTEMENT MULTIMEDIA\nPASCAL ADAM\nINGENIEUR DAFFAIRES\n4, Allée Moulin Berger - 69130 Ecully\nTel. 04 72 52 25 52\nPortable 06 74 68 52 93 - Fax 04 72 52 25 50\nPascal.Adam@teamlog.fr"
//]


//var bcDataArray = raw.split(separator: "\n")

//testPrint(tag: "RAW", title: "Separatop,", content: bcDataArray)

//var namedEntityHolder : [EntityType : NamedEntity] = [:]

//var prefixedEntities : [PrefixHolder] = []

RecognitionTools.loadTitles(completion: {
    success in
    if success {
        raws.forEach { (raw) in
            var bcDataArray = raw.split(separator: "\n").map { String($0) }
            var namedEntityHolder : [NamedEntity] = []
            var prefixedEntities : [PrefixHolder] = []
            var mutableRaw = raw
            //var namedEntityResult : [NamedEntity] = []
            
            
            // remove special remable chars
            
            testPrint(tag: "BC DATA BEFORE", title: " :: ", content: bcDataArray)
            
            testPrint(tag: "", title: "OPERATION BEGIN", content: "")
            
            RecognitionTools.preProcessRaw(raw: &mutableRaw , prefixedEntities : &prefixedEntities , bcDataArray: &bcDataArray, remove : true)
            
            testPrint(tag: "preProcessRaw", title: "RESULT", content: prefixedEntities)
            
            testPrint(tag: "BC DATA AFTER", title: " :: ", content: bcDataArray)
            
            extractEmails(raw : &mutableRaw, bcDataArray: bcDataArray, namedEntityHolder : &namedEntityHolder, prefixedEntities: prefixedEntities)
            extractWebsite(raw : &mutableRaw, bcDataArray: bcDataArray, namedEntityHolder : &namedEntityHolder, prefixedEntities: prefixedEntities)
            
            
            // make it third
            extractPhones(bcDataArray : bcDataArray , namedEntityHolder : &namedEntityHolder, prefixedEntities : prefixedEntities)
            
            // lets preprocess data before continue
            RecognitionTools.preProcessRemoveExtracted(bcDataArray : &bcDataArray, namedEntityHolder : namedEntityHolder)
            
            extractFullName(bcDataArray : bcDataArray , namedEntityHolder : &namedEntityHolder, prefixedEntities : prefixedEntities)
            RecognitionTools.preProcessRemoveExtracted(bcDataArray : &bcDataArray, namedEntityHolder : namedEntityHolder)
            extractCompany(bcDataArray : bcDataArray , namedEntityHolder : &namedEntityHolder, prefixedEntities : prefixedEntities)
            
            extractTitles(bcDataArray : bcDataArray , namedEntityHolder : &namedEntityHolder, prefixedEntities : prefixedEntities)
            
            
            
            
            
            namedEntityHolder.forEach { (named) in
                print("Extracted \(named.type) : \(named.value)  - \(named.score)")
            }
            
            
            testPrint(tag: "", title: "OPERATION END", content: "")
        }
        
        
        
        exit(EXIT_SUCCESS)
    }
})

RunLoop.main.run()


func extractWebsite(raw : inout String, bcDataArray : [String] , namedEntityHolder : inout [NamedEntity], prefixedEntities : [PrefixHolder]) -> Void {
    var computeResultHolder : [NamedEntity] = []
    bcDataArray.forEach { (line) in
        let namedEntity = NamedEntity(value: line, type: .website)
        computeResultHolder.append(contentsOf: namedEntity.computeWebsite(namedEntityHolder: namedEntityHolder, prefixes : prefixedEntities))
    }
    
    namedEntityHolder.append(contentsOf: computeResultHolder)
    // TODO : Preprocessing will use email if website not found with this OR NO NEED , bcz our regex is baddass that extract from email by his own
}


func extractEmails(raw : inout String, bcDataArray : [String] , namedEntityHolder : inout [NamedEntity], prefixedEntities : [PrefixHolder]) -> Void {
    var computeResultHolder : [NamedEntity] = []
    bcDataArray.forEach { (line) in
        let namedEntity = NamedEntity(value: line)
        computeResultHolder.append(contentsOf: namedEntity.computeEmails(namedEntityHolder: namedEntityHolder, prefixes : prefixedEntities))
    }
    
    namedEntityHolder.append(contentsOf: computeResultHolder)
}


func extractPhones( bcDataArray : [String] , namedEntityHolder : inout [NamedEntity], prefixedEntities : [PrefixHolder] ) -> Void {
    var computeResultHolder : [NamedEntity] = []
    
    // lets instantiate from here so we can depass  memory usage problem
    let phoneNumberKit = PhoneNumberKit { () -> Data? in
        return try? PhoneNumberKit.defaultMetadataCallback()
    }
    
    bcDataArray.forEach { (entity) in
        let namedEntity = NamedEntity(value: entity.description)
        
        computeResultHolder.append(contentsOf: namedEntity.computePhoneNumber(namedEntityHolder: namedEntityHolder, prefixes : prefixedEntities, phoneNumberKit: phoneNumberKit))
    }
    
    computeResultHolder.forEach { (named) in
        print("Extracted \(named.value)  -- : \(named.score)    -- : \(named.type)  -- ")
    }

    
    // this needs review .phone , .mobile,... BECAUSE IT CONTAINS SCORE
    postProcessResult(type: .phone , result: computeResultHolder , namedEntityHolder: &namedEntityHolder)
    //testPrint(tag : "Result", title : "", content : namedEntityHolder[.fullname]?.value)
    //testPrint(tag : "Result", title : "", content : namedEntityHolder[.fullname]?.score)
}

func extractFullName( bcDataArray : [String] , namedEntityHolder : inout [ NamedEntity], prefixedEntities : [PrefixHolder]) -> Void {
    
    var computeResultHolder : [NamedEntity] = []
    
    for (index,entity) in bcDataArray.enumerated() {
        let namedEntity = NamedEntity(value: entity.description , type: .fullname, position: index)
        computeResultHolder.append(namedEntity.computeFullName(namedEntityHolder: namedEntityHolder))
    }
    
    
    postProcessResult(type: .fullname , result: computeResultHolder , namedEntityHolder: &namedEntityHolder)
     
    computeResultHolder.forEach { (named) in
        print("Extracted \(named.value)  -- : \(named.score)    -- : \(named.type)  -- AT POSITION : \(named.position) ")
    }
    // TODO : POST PROCESS Result,  * remove found fields from raw values etc..
}

func extractTitles( bcDataArray : [String] , namedEntityHolder : inout [NamedEntity], prefixedEntities : [PrefixHolder]) -> Void {
    var computeResultHolder : [NamedEntity] = []
    
    
    for (index,line) in bcDataArray.enumerated() {
        let namedEntity = NamedEntity(value: line.description, type: .title, position: index)
        computeResultHolder.append(namedEntity.computeTitle(namedEntityHolder: namedEntityHolder))
    }
    
    
//    bcDataArray.forEach { (entity) in
//        let namedEntity = NamedEntity(value: entity.description , type: .title)
//        computeResultHolder.append(namedEntity.computeTitle(namedEntityHolder: namedEntityHolder))
//    }
    
    computeResultHolder.forEach { (item) in
        print("TITLE Value : \(item.value)  -- Score : \(item.score)")
    }
    
    postProcessResult(type: .title , result: computeResultHolder, namedEntityHolder: &namedEntityHolder)
    testPrint(tag : "Result TITLE", title : "", content : namedEntityHolder)
    //testPrint(tag : "Result TITLE", title : "", content : namedEntityHolder)
    
}

func extractCompany( bcDataArray : [String] , namedEntityHolder : inout [NamedEntity], prefixedEntities : [PrefixHolder]) -> Void {
    
    var computeResultHolder : [NamedEntity] = []
    bcDataArray.forEach { (entity) in
        let namedEntity = NamedEntity(value: entity.description, type: .company)
        computeResultHolder.append(namedEntity.computeCompany(namedEntityHolder: namedEntityHolder))
    }

    
    if computeResultHolder.filter({ (namedEntityCompany) -> Bool in
        namedEntityCompany.score > 30
    }).count < 1 {
        // considered LoW
        // IF SCORE IS CONSIDERED LOW - / 30 , then maybe process email and title to get something from them
        let namedEntity = NamedEntity(value: "" , type: .company)
        computeResultHolder.append(contentsOf: namedEntity.computeCompanyFromWebsiteOrEmail(namedEntityHolder: namedEntityHolder))
    }
    
    computeResultHolder.forEach { (item) in
        print("COMPANY Value : \(item.value)  -- Score : \(item.score)")
    }
    
    // TODO : POST PROCESS Result,  * remove found fields from raw values etc..
    postProcessResult(type: .company , result: computeResultHolder, namedEntityHolder: &namedEntityHolder)
}

func postProcessResult(type : EntityType, result : [NamedEntity], namedEntityHolder : inout [NamedEntity]) {
    
    
    //namedEntityHolder[type] = result.sorted(by: {$0.score > $1.score }).first
    
    switch type {
        
    case .title : do {
        // process titles with score SUPP TO : 50
        result
            .sorted(by: {$0.score > $1.score })
            .filter({$0.score > 50})
            .forEach { (proposedTitle) in
                if namedEntityHolder.contains(where: {$0.type == .title}) {
                    // we already have a title
                    namedEntityHolder.append(NamedEntity(value: proposedTitle.value, type: .title2, position: proposedTitle.position))
                }else{
                    // we put it in title 2
                    namedEntityHolder.append(NamedEntity(value: proposedTitle.value, type: .title, position: proposedTitle.position))
                }
        }
        
        }
        
    case .phone : do {
        namedEntityHolder.append(contentsOf: result)
        }
    default:
        namedEntityHolder.append(result.sorted(by: {$0.score > $1.score }).first ?? NamedEntity(value: ""))
        break
    }
    
//    if type != .phone {
//        namedEntityHolder.append(result.sorted(by: {$0.score > $1.score }).first ?? NamedEntity(value: ""))
//    }else{
//        // IS PHONE :
//
//        namedEntityHolder.append(contentsOf: result)
//    }
    
    
//    let phoneCharsSepartors = [
//        "/",
//        "\\"
//    ]
    
    
    
}

//******************************       PROCESS         ******************************//

class RecognitionTools {
    
    static func loadTitles(completion : @escaping (_ : Bool) -> ()) {
        let url = URL(string: "http://api.abracardabra.test-360.net/titles")!
        var request = URLRequest(url: url)
        request.httpMethod = "GET"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")
        URLSession.shared.dataTask(with: request) {(data, response, error) in
            if let _ = error {
            }else if let response = response as? HTTPURLResponse {
                
                // todo : make it check for status code or data before continiuing
                if response.statusCode == 200 {
                    do {
                        let decoder = JSONDecoder()
                        let citiesResponse = try decoder.decode(titlesPMSuccess.self, from: data!)
                        
                        lowerCasejobTitles.append(contentsOf: citiesResponse.success.data.map({$0.title_name.trimmedAndLowercased}))
                        completion( true)
                       
                    } catch _ {
                        completion(false)
                    }
                }
                
            }
        }.resume()
    }

    static func preProcessRemoveExtracted(bcDataArray : inout [String] , namedEntityHolder: [ NamedEntity]) -> Void {
        // use namedEntityHolder remove from bcDataArra
        var array : [String] = []
        for (_,line) in bcDataArray.enumerated() {
            
            
            if namedEntityHolder.contains(where: {$0.value == line}) {
                
                array.append("")
//            }
//
//
//            if (line.description.existInArray(array: namedEntityHolder.map({
//                $0.value
//            }))){
                // need to remove
                //print("Removing INDEX \(index)")
                //bcDataArray.remove(at: index)
            }else{
                array.append(line)
            }
        }
        
        bcDataArray = array
    }

    
    static func preProcessRaw(raw : inout String , prefixedEntities : inout [PrefixHolder] , bcDataArray : inout [String], remove : Bool = false) -> Void {
        
        prefixedEntities = preProcessPrefixes(raw: raw, bcDataArray: &bcDataArray, removeKeys: remove)
        
        testPrint(tag: "Prerpcess ", title: "Extracted prefixedEntities", content: prefixedEntities)
        
    }
    
    ///This preprocess function only care about KEY : VALUE , where content of key value doesnt matter
    private static func preProcessPrefixes(raw : String , bcDataArray : inout [String], removeKeys: Bool ) -> [PrefixHolder] {
        var prefixesEntities : [PrefixHolder] = []
        for (index,line) in bcDataArray.enumerated() {
            // lets do the separation stuff BASED ON " : " Prefix
            
            // if prefix KEY found with empty VALUE , supress Take the next line as VALUE
            let separatorOccurenceByPoint = line.components(separatedBy:":")
            //testPrint(tag: "Prefix ", title: "separation BY 2POINT", content: separatorOccurenceByPoint)
            switch separatorOccurenceByPoint.count {
            case 2 : do {
                // this is our best bet Key : Val
                if separatorOccurenceByPoint[1].count == 0 {
                    // we got empty VALUE so we grab it eye closes from next line
                    prefixesEntities.append(PrefixHolder(key: separatorOccurenceByPoint.first ?? "", value: String(bcDataArray[index+1]) , type: .safe))
                    //bcDataArray[index] = line.replacingOccurrences(of: bcDataArray[index], with: "")
                }else{
                    prefixesEntities.append(PrefixHolder(key: separatorOccurenceByPoint.first ?? "", value: separatorOccurenceByPoint[1] , type: .safe))
                }
                
                 bcDataArray[index] = line.replacingOccurrences(of: separatorOccurenceByPoint[0], with: "")
                
                break
                }
                
            case let val where val > 2 : do {
                // this is strange case , contains more than 2 separtor
                }
                
                
            default:
                // just ignore those because they dont contain any separtor
                break
            }
            
            // AT THIS STAGE : We extracted lines with ":"
            
            // PROCESS STUFF BASED ON Word espace Content of known type
            // TODOO : Process those who begins with PREFIX ( in the known prefix tbale ) / espace / CONTENT OF TYPE : NUMBER
            
            //lets do more with char
            
            // if prefix KEY found with empty VALUE , supress Take the next line as VALUE
            let separatorOccurenceBySpace = line.components(separatedBy:" ")
            //testPrint(tag: "Prefix ", title: "separation BY SPACE", content: separatorOccurenceBySpace)
            
            if separatorOccurenceBySpace.count > 1 {
                if let firstElement = separatorOccurenceBySpace.first {
                    let removedFirst = separatorOccurenceBySpace.dropFirst()
                    if firstElement.lengthBetween(l1: 1, l2: 7)
                        && firstElement.existInArray(array: RecognitionTools.businessCardPrefixes.flatMap({$0}) , preprocess: true)
                        && !firstElement.existInArray(array: prefixesEntities.map({$0.key}))
                    {
                        // i guess wee found some prefix so lets pretend
                        
                        prefixesEntities.append(PrefixHolder(key: firstElement, value: removedFirst.joined(separator: " ") , type: .unsafe))
                    }
                    // else ignore
                }
            }
            
        }
//        if removeKeys {
//            //bcDataArray = bcDataArray.filter(prefixesEntities.map({$0.value}). contains(where: {$0 == ""}))
//
//            bcDataArray = bcDataArray. filter({ (element) -> Bool in
//                prefixesEntities.contains { (prefiexItem) -> Bool in
//                    prefiexItem.value == element
//                }
//            })
//        }
        
        return prefixesEntities
        
    }
    
    static var removeableChars : [Character] = [
        "!", "#", "$", "%", "&" , "*" , "/" , "<", ">" , "?" , "|" , "_" , ":" , "-" , "."
    ]
    
    static var webSitePrefixes = [
    "www.",
    "http://",
    "https://",
    ]
    
    static var webSiteSuffixes = [
    ".com",
    ".de",
    ".da",
    "."
    
    ]
    
    static var emailsDomains = [
        /* Default domains included */
        "aol", "att", "comcast", "facebook", "gmail", "gmx", "googlemail",
        "google", "hotmail", "mac", "me", "mail", "msn",
        "live", "sbcglobal", "verizon", "yahoo",
        
        /* Other global domains */
        "email", "fastmail", "games" /* AOL */,  "hush", "hushmail", "icloud",
        "iname", "inbox", "lavabit", "love" /* AOL */, "pobox", "protonmail", "protonmail", "tutanota", "tutamail", "tuta",
        "keemail", "rocketmail" /* Yahoo */, "safe-mail", "wow" /* AOL */, "ygm" /* AOL */,
        "ymail" /* Yahoo */, "zoho", "yandex",
        
        /* United States ISP domains */
        "bellsouth", "charter", "cox", "earthlink", "juno",
        
        /* British ISP domains */
        "btinternet", "virginmedia", "blueyonder", "freeserve", "live",
        "ntlworld", "o2", "orange", "sky", "talktalk", "tiscali",
        "virgin", "wanadoo", "bt",
        
        /* Domains used in Asia */
        "sina", "sina", "qq", "naver", "hanmail", "daum", "nate", "yahoo", "163", "yeah", "126", "21cn", "aliyun", "foxmail",
        
        /* French ISP domains */
        "live", "laposte", "wanadoo", "orange", "gmx", "sfr", "neuf", "free",
        
        /* German ISP domains */
        "gmx", "hotmail", "live", "online", "t-online" /* T-Mobile */, "web",
        
        /* Italian ISP domains */
        "libero", "virgilio", "hotmail" , "tiscali", "alice", "live", "email", "tin", "poste", "teletu",
        
        /* Russian ISP domains */
        "mail", "rambler", "yandex", "ya", "list",
        
        /* Belgian ISP domains */
        "hotmail", "live", "skynet", "voo", "tvcablenet", "telenet",
        
        /* Argentinian ISP domains */
        "hotmail", "live", "fibertel", "speedy", "arnet",
        
        /* Domains used in Mexico */
        "live", "hotmail", "hotmail", "prodigy",
        
        /* Domains used in Canada */
        "bell", "shaw", "sympatico", "rogers",
        
        /* Domains used in Brazil */
        "yahoo", "hotmail", "outlook", "uol", "bol", "terra", "ig", "itelefonica", "r7", "zipmail", "globo", "globomail", "oi"
    ]
    
    static var directPrefixes = [
        "d",
        "direct",
        "dir.",
        "line",
        "line."
    ]
    
    static var phonePrefixes = [
        "p",
        "phone",
        "phone.",
        "p",
        "tel.",
        "tél.",
        "t.",
        "t"
    ]
    
    static var mobilePrefixes = [
        "m",
        "mobile",
        "mobile.",
        "portable",
        "portable."
    ]
    
    static var faxPrefixes = [
        "f",
        "fax",
        "fax."
    ]
    
    static var emailPrefixes = [
           "e",
           "email",
           "e-mail",
           "mail"
       ]
    
    
    
    static var websiteRegex = "\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))"
    //IS MORE HARDCORE EXTRACTING EVERY THINK WITH X.Y"(?:(?:https?|ftp):\\/\\/)?[\\w/\\-?=%.]+\\.[\\w/\\-?=%.]+"
    
    static var emailRegex = "(?:[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*|\"(?:[\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x21\\x23-\\x5b\\x5d-\\x7f]|\\[\\x01-\\x09\\x0b\\x0c\\x0e-\\x7f])*\")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x21-\\x5a\\x53-\\x7f]|\\[\\x01-\\x09\\x0b\\x0c\\x0e-\\x7f])+)\\])"
    
    static var numberPhoneRegexFromString = "(?<=[ ])[\\d \\-+()]+$|(?<=[ ])[\\d \\-+()]+(?=[ ]\\w)"
    
    static var numberPhoneRegexFromStringComplex = "(?:(?:\\+?([1-9]|[0-9][0-9]|[0-9][0-9][0-9])\\s*(?:[.-]\\s*)?)?(?:\\(\\s*([2-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9])\\s*\\)|([0-9][1-9]|[0-9]1[02-9]|[2-9][02-8]1|[2-9][02-8][02-9]))\\s*(?:[.-]\\s*)?)?([0-9]1[02-9]|[2-9][02-9]1|[2-9][02-9]{2})\\s*(?:[.-]\\s*)?([0-9]{4})(?:\\s*(?:#|x\\.?|ext\\.?|extension)\\s*(\\d+))?"
    
    
    static var numberSinglePhoneRegexWithNoSpecial = "^[+]*[(]{0,1}[0-9]{1,4}[)]{0,1}[-\\s\\./0-9]*$"
    
    static var businessCardPrefixes = [
        emailPrefixes,
        faxPrefixes,
        mobilePrefixes,
        phonePrefixes,
        directPrefixes
    ]
    
    static var removableNamesSpecial = [",","@","&"]
    
    static var lowerCasejobTitles = ["diplom","it"]
    
    static var lowerCaseNamesPrefixes = [
        "mr.",
        "mrs.",
        "ms.",
        "miss",
        "dr.",
        "dr",
        "a.v.m",
        "adm.",
        "amb",
        "amn",
        "archbishop",
        "baron",
        "baroness",
        "bishop",
        "brig. gen.",
        "bigadier",
        "bro.",
        "cantor",
        "capt.",
        "cardinal",
        "chaplain",
        "cmdr.",
        "cmsgt",
        "col.",
        "consul",
        "count",
        "countess",
        "cpl.",
        "cpo",
        "cwo",
        "dean",
        "duchess",
        "duke",
        "earl",
        "ens.",
        "eur eng",
        "father",
        "fr.",
        "gen.",
        "gov.",
        "h. e.",
        "herr",
        "hon",
        "hrh",
        "lady",
        "lord",
        "lt.",
        "lt. cmdr.",
        "lt. col.",
        "lt. gen.",
        "m.",
        "maj.",
        "maj. gen",
        "master",
        "mile.",
        "mme.",
        "mother",
        "msgt",
        "pastor",
        "pfc",
        "pres.",
        "prince",
        "princess",
        "prof.",
        "rabbi",
        "radm",
        "rev.",
        "rt. hon.",
        "senator",
        "sgt.",
        "sgt. maj.",
        "sir",
        "sister",
        "smsgt",
        "speaker",
        "squad. ldr.",
        "sr.",
        "sra",
        "sra",
        "srta",
        "ssgt",
        "swami",
        "stsgt"
    ]
    
}

enum PrefixType {
    case safe
    case unsafe
}

struct PrefixHolder {
    var key : String
    var value : String
    var type : PrefixType = .unsafe
}

func testPrint<T>(tag : String, title : String, content : T){
    //print("------------------------ \(tag) - \(title) ---------------------------\n")
    
    print("\n\(tag) - \(title)  : > \(content) \n")
    
    //print("\n------------------------ END \(title) --------------------------- \n\n")
}

struct titlesPMSuccess : Codable {
    let success : titlesPMResponse
}
struct titlesPMResponse : Codable {
    let statusCode : Int
    let message : String
    let data : [titlesPM]
}
struct titlesPM : Codable {
    let id : Int
    let title_name : String
    let createdAt : String
}

